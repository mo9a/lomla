<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LOMLA.land ‚Äî Secret</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --olive:#6B7A4F;
      --cream:#FAF7F2;
      --blush:#E6CFC2;
      --gold:#C8A24A;

      --text:#1f2418;
      --muted:#5a5f50;

      --border:1px solid rgba(107,122,79,.18);
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --shadow-sm:0 6px 18px rgba(0,0,0,.05);

      --r-lg:20px;
      --r-md:14px;

      --bg-panel: rgba(250,247,242,.78);
      --bg-panel-strong: rgba(250,247,242,.86);
      --bg-btn: rgba(250,247,242,.75);
      --bg-btn2: rgba(250,247,242,.78);
      --overlay: rgba(0,0,0,.40);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(800px 280px at 70% 0%, rgba(200,162,74,.16), transparent 60%),
        radial-gradient(900px 420px at 15% 18%, rgba(230,207,194,.22), transparent 60%),
        url("pics/secret4.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    a{color:inherit;text-decoration:none}
    .wrap{max-width:1080px;margin:0 auto;padding:26px 18px 60px}

    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:var(--border);
      background: var(--bg-btn);
      color:var(--olive);
      padding:10px 14px;
      border-radius:999px;
      box-shadow:var(--shadow-sm);
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
      user-select:none;
      font-weight:500;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow);}
    .btn.primary{
      background: linear-gradient(135deg, rgba(107,122,79,.96), rgba(107,122,79,.86));
      color: var(--cream);
      border: 1px solid rgba(107,122,79,.55);
    }
    .btn.danger{
      border:1px solid rgba(160,60,60,.28);
      color:#7a2f2f;
      background:rgba(250,247,242,.88);
    }

    .panel{
      background: var(--bg-panel);
      border:var(--border);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(8px);
    }

    h1,h2{
      font-family:"Playfair Display",serif;
      margin:0 0 10px;
      color:var(--olive);
      letter-spacing:.2px;
    }
    h1{font-size:28px}
    h2{font-size:20px}
    p{margin:0;color:var(--muted);line-height:1.8;font-size:14px}

    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .hero{grid-template-columns:1fr;} }

    .grid2{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr;} }

    .card{
      border:var(--border);
      background:rgba(250,247,242,.82);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow-sm);
      padding:16px;
      transition: transform .18s ease, box-shadow .18s ease;
      position:relative;
      overflow:hidden;
      cursor:pointer;
    }
    .card:hover{transform:translateY(-2px); box-shadow:var(--shadow);}
    .card .title{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .card .title b{color:var(--olive); font-size:14px;}
    .card small{color:var(--muted); line-height:1.6; display:block;}

    .favList{display:flex; flex-direction:column; gap:10px; margin-top:12px;}
    .favItem{
      border:var(--border);
      background:rgba(250,247,242,.86);
      border-radius:16px;
      padding:12px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      box-shadow:var(--shadow-sm);
    }
    .favItem b{color:var(--olive); font-size:13px;}
    .favItem p{margin-top:6px; font-size:13px; color:var(--muted)}
    .mini{
      border:var(--border);
      background:rgba(250,247,242,.9);
      color:var(--olive);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-size:12px;
      box-shadow:var(--shadow-sm);
      user-select:none;
    }
    .mini:hover{transform:translateY(-1px); box-shadow:var(--shadow);}

    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .tab{
      border:var(--border);
      background:rgba(250,247,242,.82);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-size:12.5px;
      color:var(--olive);
      box-shadow:var(--shadow-sm);
      user-select:none;
      transition: transform .18s ease, background .18s ease;
    }
    .tab:hover{transform:translateY(-1px);}
    .tab.active{
      background:rgba(107,122,79,.12);
      border:1px solid rgba(107,122,79,.35);
    }

    .photos{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){ .photos{grid-template-columns:repeat(2, 1fr);} }

    .photo{
      border-radius:20px;
      border:var(--border);
      background:rgba(250,247,242,.92);
      overflow:hidden;
      box-shadow:var(--shadow-sm);
      cursor:pointer;
      position:relative;
      min-height:120px;
      padding:10px;
    }
    .photo img{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(107,122,79,.14);
    }
    .cap{
      position:absolute;
      left:14px;
      bottom:14px;
      right:14px;
      background:rgba(250,247,242,.92);
      border:1px solid rgba(200,162,74,.28);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--olive);
      backdrop-filter: blur(6px);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      z-index:3;
    }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.40);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(760px, 100%);
      background:rgba(250,247,242,.95);
      border:var(--border);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .modalHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(107,122,79,.12);
    }
    .modalHead b{color:var(--olive)}
    .close{
      cursor:pointer;
      padding:6px 10px;
      border-radius:999px;
      border:var(--border);
      background:rgba(250,247,242,.9);
      color:var(--olive);
    }
    .modalBody{padding:16px;}
    .letterText{
      border-radius:16px;
      border:1px solid rgba(230,207,194,.65);
      background:rgba(230,207,194,.20);
      padding:14px;
      color:#2a2f22;
      line-height:1.9;
      font-size:14px;
    }

    .surpriseBox{
      border-radius:16px;
      border:1px solid rgba(230,207,194,.65);
      background:rgba(230,207,194,.18);
      padding:14px;
      line-height:1.9;
      color:#2a2f22;
      margin-top:10px;
    }

    .huntRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;}
    .huntInput{
      flex:1 1 240px;
      border:1px solid rgba(107,122,79,.25);
      background:rgba(250,247,242,.92);
      border-radius:999px;
      padding:12px 14px;
      outline:none;
      font-size:14px;
      color:var(--text);
      box-shadow:var(--shadow-sm);
    }
    .hint{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.7;}
    .giftGrid{margin-top:12px;display:grid;grid-template-columns:repeat(2, 1fr);gap:10px;}
    @media (max-width: 980px){ .giftGrid{grid-template-columns:1fr;} }
    .gift{
      border:var(--border);
      border-radius:18px;
      padding:14px;
      background:rgba(250,247,242,.86);
      box-shadow:var(--shadow-sm);
    }
    .gift b{color:var(--olive)}
    .gift p{margin-top:6px;font-size:13px;}

    /* ===== PUZZLE GATE ===== */
    .gate{
      position:fixed;
      inset:0;
      z-index:10000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
      background:
        radial-gradient(700px 260px at 70% 15%, rgba(200,162,74,.18), transparent 60%),
        radial-gradient(850px 340px at 15% 20%, rgba(230,207,194,.22), transparent 60%),
        linear-gradient(180deg, rgba(168,177,143,.25), rgba(250,247,242,1) 40%);
      backdrop-filter: blur(6px);
    }
    .gateCard{
      width:min(980px, 100%);
      background: rgba(250,247,242,.88);
      border: var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      position:relative;
      overflow:hidden;
    }
    .gateTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .gateTitle{
      margin:0;
      font-family:"Playfair Display", serif;
      font-size:22px;
      color: var(--olive);
    }
    .gateText{
      margin:6px 0 0;
      color: var(--muted);
      line-height:1.7;
      font-size:13px;
    }
    .gateError{
      display:none;
      margin-top:10px;
      border-radius: 14px;
      border: 1px solid rgba(230,207,194,.65);
      background: rgba(230,207,194,.22);
      padding: 10px 12px;
      color:#2a2f22;
      line-height:1.7;
      font-size:13px;
    }
    .gateError.show{display:block}

    .puzzleLayout{
      display:grid;
      grid-template-columns: 1fr 280px;
      gap:14px;
      align-items:start;
      margin-top:10px;
    }
    @media (max-width: 860px){
      .puzzleLayout{grid-template-columns:1fr;}
    }
    .puzzleBoard{
      border: var(--border);
      border-radius: 18px;
      background: rgba(250,247,242,.78);
      box-shadow: var(--shadow-sm);
      padding: 12px;
    }
    .boardGrid{
      width:min(520px, 100%);
      aspect-ratio: 1 / 1;
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .tile{
      border-radius:14px;
      border:1px solid rgba(107,122,79,.18);
      background:rgba(250,247,242,.85);
      box-shadow: var(--shadow-sm);
      cursor:pointer;
      overflow:hidden;
    }
    .tile.empty{
      background:transparent;
      border:1px dashed rgba(107,122,79,.28);
      cursor:default;
      box-shadow:none;
    }
    .hintOverlay{
      width:min(520px,100%);
      aspect-ratio:1/1;
      margin:10px auto 0;
      border-radius:18px;
      overflow:hidden;
      border:var(--border);
      background:rgba(250,247,242,.75);
      box-shadow:var(--shadow-sm);
      display:none;
      position:relative;
    }
    .hintOverlay.show{display:block;}
    .hintOverlay img{width:100%;height:100%;object-fit:cover;display:block;opacity:.55;}

    .puzzleSide{
      border: var(--border);
      border-radius: 18px;
      background: rgba(250,247,242,.78);
      box-shadow: var(--shadow-sm);
      padding: 12px;
    }
    .preview{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(107,122,79,.18);
      overflow:hidden;
      background: rgba(250,247,242,.8);
      box-shadow: var(--shadow-sm);
    }
    .preview img{width:100%;display:block;object-fit:cover;}
    .miniHint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.7;}
    .gateBtns{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;}
    .smallNote{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.7;}
  </style>
</head>

<body>
  <!-- PUZZLE GATE -->
  <div class="gate" id="gate" aria-label="Puzzle gate">
    <div class="gateCard">
      <div class="gateTop">
        <div>
          <div class="gateTitle">Unlock the Secret Area üß©</div>
          <div class="gateText">Easy 3√ó3 mode. Slide tiles into the empty space.</div>
        </div>

        <!-- ‚úÖ Buttons near puzzle (music here) -->
        <div class="actions">
          <button class="btn danger" id="skipBtn" type="button" title="Skip puzzle and enter">Skip ‚Üí</button>
          <button class="btn" id="musicBtn" type="button">üéµ Music</button>
          <a class="btn" href="index.html">‚Üê Home</a>
          <button class="btn" id="resetBtn" type="button" title="Clears favorites + unlocks on this device">Reset</button>
        </div>
      </div>

      <div class="puzzleLayout">
        <div class="puzzleBoard">
          <div class="boardGrid" id="board"></div>
          <div class="hintOverlay" id="hintOverlay">
            <img id="hintImg" alt="Hint image" />
          </div>
          <div class="gateError" id="gateError">Not solved yet ü§ç Keep going.</div>
        </div>

        <div class="puzzleSide">
          <div class="preview">
            <img id="previewImg" alt="Puzzle preview" />
          </div>
          <div class="miniHint">Tip: press ‚ÄúHint‚Äù to show the full image softly.</div>

          <div class="gateBtns">
            <button class="btn" id="shuffleBtn" type="button">Shuffle (Easy)</button>
            <button class="btn" id="hintBtn" type="button">Hint</button>
            <button class="btn primary" id="checkBtn" type="button">Check ‚úì</button>
          </div>

          <div class="smallNote">
            If images don‚Äôt show on <b>file://</b>, run via Live Server / local server.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="wrap" id="secretContent" style="display:none">
    <div class="actions" style="justify-content:space-between;margin-bottom:14px;">
      <div style="display:flex;gap:10px;align-items:baseline;">
        <div style="font-family:'Playfair Display',serif;font-size:26px;color:var(--olive);font-weight:600;">Secret</div>
        <div style="font-size:12px;color:var(--muted);border:var(--border);background:rgba(250,247,242,.75);padding:6px 10px;border-radius:999px;">
          Photos ‚Ä¢ Letters ‚Ä¢ Unlocks
        </div>
      </div>
      <div class="actions">
        <!-- ‚úÖ optional second music button after unlock -->
        <button class="btn" id="musicBtn2" type="button">üéµ Music</button>
        <a class="btn" href="index.html">‚Üê Home</a>
        <button class="btn" id="resetBtn2" type="button">Reset</button>
      </div>
    </div>

    <section class="hero">
      <div class="panel">
        <h1>Open-When Letters ü§ç</h1>
        <p>Tap a card to open it. You can save favorites on this device.</p>
        <div class="grid2" id="lettersGrid"></div>

        <div style="margin-top:16px">
          <h2>Favorites</h2>
          <p>Saved letters appear here (only on this device).</p>
          <div class="favList" id="favList"></div>
        </div>
      </div>

      <div class="panel">
        <h1>Secret Gallery üì∑</h1>
        <p>Albums + captions + a clean lightbox.</p>

        <div class="tabs" id="albumTabs"></div>
        <div class="photos" id="photosGrid"></div>

        <div style="margin-top:18px">
          <h2>Daily Surprise üéÅ</h2>
          <p>One message per day (you can re-roll if you want).</p>
          <div class="surpriseBox" id="dailyBox">‚Äî</div>
          <div class="huntRow">
            <button class="btn" id="rerollBtn" type="button">Re-roll ‚ú®</button>
          </div>
        </div>

        <div style="margin-top:18px">
          <h2>Clue Hunt üîé</h2>
          <p>Enter secret codes to unlock little gifts.</p>

          <div class="huntRow">
            <input class="huntInput" id="codeInput" placeholder="Enter code (example: LIA)" />
            <button class="btn primary" id="unlockBtn" type="button">Unlock</button>
          </div>

          <div class="hint" id="huntHint">
            Hints: try <b>LIA</b>, <b>HUSISA</b>, or the date <b>20251225</b> üòâ
          </div>

          <div class="giftGrid" id="giftGrid"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Overlay modal -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal" id="modal">
      <div class="modalHead">
        <b id="modalTitle">‚Äî</b>
        <button class="close" id="modalClose" type="button">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <!-- ‚úÖ AUDIO MUST BE BEFORE SCRIPT -->
  <audio id="bgMusic" loop preload="auto">
    <source src="assets/music.mp3" type="audio/mpeg">
  </audio>

  <script>
    /* =========================
       MUSIC (same style as Index)
    ========================== */
    const MUSIC_KEY = "lomla_music_on";
    const musicBtn  = document.getElementById("musicBtn");
    const musicBtn2 = document.getElementById("musicBtn2");
    const bgMusic   = document.getElementById("bgMusic");

    function setMusicBtnLabel(on){
      if(musicBtn)  musicBtn.textContent  = on ? "‚è∏ Music" : "üéµ Music";
      if(musicBtn2) musicBtn2.textContent = on ? "‚è∏ Music" : "üéµ Music";
    }

    async function setMusic(on){
      localStorage.setItem(MUSIC_KEY, on ? "1" : "0");
      setMusicBtnLabel(on);

      if(!bgMusic) return;
      bgMusic.volume = 0.22;

      try{
        if(on){
          await bgMusic.play();
        }else{
          bgMusic.pause();
        }
      }catch(e){
        // autoplay blocked ‚Äî will be retried on next user interaction
        console.log("Music play blocked:", e);
      }
    }

    function toggleMusic(){
      const isOn = localStorage.getItem(MUSIC_KEY) === "1";
      setMusic(!isOn);
    }

    musicBtn?.addEventListener("click", toggleMusic);
    musicBtn2?.addEventListener("click", toggleMusic);

    // Restore saved state
    const savedMusicOn = localStorage.getItem(MUSIC_KEY) === "1";
    setMusicBtnLabel(savedMusicOn);

    // Try play again after any interaction if saved ON
    window.addEventListener("pointerdown", () => {
      if(localStorage.getItem(MUSIC_KEY) === "1" && bgMusic && bgMusic.paused){
        bgMusic.play().catch(()=>{});
      }
    }, { once:false });

    /* =========================
       PUZZLE GATE (EASY 3√ó3)
    ========================== */
    const PUZZLE_IMAGE = "pics/puzzle.png.jpeg";
    const N = 3;
    const EMPTY = N*N - 1;
    const EASY_SHUFFLE_MOVES = 18;

    const gate = document.getElementById("gate");
    const gateError = document.getElementById("gateError");
    const boardEl = document.getElementById("board");
    const previewImg = document.getElementById("previewImg");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const checkBtn = document.getElementById("checkBtn");
    const skipBtn = document.getElementById("skipBtn");

    const hintOverlay = document.getElementById("hintOverlay");
    const hintImg = document.getElementById("hintImg");
    const hintBtn = document.getElementById("hintBtn");

    let tiles = [];
    let emptyIndex = EMPTY;

    function preload(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error("Failed to load: " + src));
        img.src = src;
      });
    }

    function makeSolved(){
      tiles = Array.from({length: N*N}, (_, i) => i);
      emptyIndex = EMPTY;
    }

    function isSolved(){
      for (let i=0; i<tiles.length; i++){
        if (tiles[i] !== i) return false;
      }
      return true;
    }

    function neighbors(idx){
      const r = Math.floor(idx / N);
      const c = idx % N;
      const res = [];
      if (r > 0) res.push(idx - N);
      if (r < N-1) res.push(idx + N);
      if (c > 0) res.push(idx - 1);
      if (c < N-1) res.push(idx + 1);
      return res;
    }

    function swap(a,b){
      const t = tiles[a];
      tiles[a] = tiles[b];
      tiles[b] = t;
    }

    function shuffle(moves = EASY_SHUFFLE_MOVES){
      gateError.classList.remove("show");
      makeSolved();
      for (let i=0; i<moves; i++){
        const nbs = neighbors(emptyIndex);
        const pick = nbs[Math.floor(Math.random() * nbs.length)];
        swap(pick, emptyIndex);
        emptyIndex = pick;
      }
      if (isSolved()) shuffle(moves + 2);
    }

    function renderBoard(){
      boardEl.innerHTML = "";
      for (let i=0; i<tiles.length; i++){
        const val = tiles[i];
        const tile = document.createElement("div");
        tile.className = "tile" + (val === EMPTY ? " empty" : "");

        if (val !== EMPTY){
          const sr = Math.floor(val / N);
          const sc = val % N;
          const x = (sc * 100) / (N-1);
          const y = (sr * 100) / (N-1);

          tile.style.backgroundImage = `url('${PUZZLE_IMAGE}')`;
          tile.style.backgroundSize = `${N*100}% ${N*100}%`;
          tile.style.backgroundPosition = `${x}% ${y}%`;

          tile.addEventListener("click", () => tryMove(i));
        }
        boardEl.appendChild(tile);
      }
    }

    function tryMove(idx){
      const nbs = neighbors(emptyIndex);
      if (!nbs.includes(idx)) return;
      swap(idx, emptyIndex);
      emptyIndex = idx;
      renderBoard();
      if (isSolved()) unlockGate();
    }

    function unlockGate(){
      gateError.classList.remove("show");
      gate.style.display = "none";
      document.getElementById("secretContent").style.display = "block";

      // if user already had music ON, try to play again after unlock
      if(localStorage.getItem(MUSIC_KEY) === "1"){
        bgMusic?.play().catch(()=>{});
      }
    }

    shuffleBtn.addEventListener("click", () => { shuffle(EASY_SHUFFLE_MOVES); renderBoard(); });
    checkBtn.addEventListener("click", () => { isSolved() ? unlockGate() : gateError.classList.add("show"); });
    skipBtn.addEventListener("click", unlockGate);
    hintBtn.addEventListener("click", () => hintOverlay.classList.toggle("show"));

    preload(PUZZLE_IMAGE).then(() => {
      previewImg.src = PUZZLE_IMAGE;
      hintImg.src = PUZZLE_IMAGE;
      shuffle(EASY_SHUFFLE_MOVES);
      renderBoard();
    }).catch((err) => {
      gateError.textContent = "Puzzle image not loading. (" + err.message + ")";
      gateError.classList.add("show");
    });

    /* =====================
       SECRET APP (content)
    ====================== */
    const LETTERS = [
      { id:"sad", title:"Open when you‚Äôre sad", icon:"‚òÅÔ∏è",
        text:"Even on the hard days, you‚Äôre not alone. I‚Äôm here ‚Äî always. Take one deep breath‚Ä¶ then another. ü§ç" },
      { id:"miss", title:"Open when you miss me", icon:"ü§ç",
        text:"Missing is proof that something real exists. We matter. And we‚Äôll make more memories ‚Äî again and again. üåø" },
      { id:"stress", title:"Open when you‚Äôre stressed", icon:"ü´ñ",
        text:"You don‚Äôt have to carry everything at once. Do one small thing. Then rest. I believe in you. ‚ú®" },
      { id:"sleep", title:"Open when you can‚Äôt sleep", icon:"üåô",
        text:"Close your eyes. Imagine me saying: ‚ÄòGood night, Lomla.‚Äô Slow breaths‚Ä¶ you‚Äôre safe. ü§ç" },
      { id:"motivation", title:"Open when you need motivation", icon:"üìê",
        text:"Tiny steps build beautiful plans. You‚Äôre more capable than you feel today. Keep going. ‚ú®" }
    ];

    const ALBUMS = [
      { id:"us", name:"Us ü§ç", photos:[
          { src:"pics/us2.jpeg", caption:"A memory I want to keep forever." },
          { src:"pics/us3.jpeg", caption:"Soft moments, strong hearts." }
      ]},
      { id:"cats", name:"Cats üêæ", photos:[
          { src:"pics/lia.jpeg", caption:"LIA in jail" },
          { src:"pics/husisa2.jpeg", caption:"Nice T-Shirt HUSISA!!!" }
      ]}
    ];

    const SURPRISES = [
      "You‚Äôre loved more than you realize. ü§ç",
      "Your presence makes the world softer. üåø",
      "You don‚Äôt need to be perfect to be amazing. ‚ú®",
      "One day you‚Äôll look back and smile. ‚òÄÔ∏è",
      "I‚Äôm proud of you ‚Äî quietly, deeply, always. ü§ç",
      "Small steps still count. Keep building. üìê"
    ];

    const GIFTS = [
      { code: "LIA", title: "Gift #1: The Queen‚Äôs Blessing üëë", text: "You are officially protected by Himalayan royalty." },
      { code: "HUSISA", title: "Gift #2: Guardian Mode üõ°Ô∏è", text: "If anyone annoys you today‚Ä¶ HUSISA says: ‚ÄòNo.‚Äô üòå" },
      { code: "20251225", title: "Gift #3: First Date Memory üéÑ", text: "A reminder: that day was real, and it was beautiful." }
    ];

    const FAV_KEY = "lomla_secret_favs";
    const UNLOCK_KEY = "lomla_secret_unlocks";
    const REROLL_KEY = "lomla_secret_reroll_offset";

    function readJSON(key, fallback){
      try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
      catch{ return fallback; }
    }
    function writeJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    // Modal
    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalClose = document.getElementById("modalClose");

    function openModal(title, bodyHTML){
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHTML;
      overlay.classList.add("show");
    }
    function closeModal(){
      overlay.classList.remove("show");
      modalBody.innerHTML = "";
    }
    modalClose.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Letters + Favorites
    const lettersGrid = document.getElementById("lettersGrid");
    const favList = document.getElementById("favList");

    function getFavs(){ return readJSON(FAV_KEY, []); }
    function setFavs(list){ writeJSON(FAV_KEY, list); }

    function renderLetters(){
      lettersGrid.innerHTML = "";
      LETTERS.forEach(L => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="title">
            <b>${L.icon} ${escapeHTML(L.title)}</b>
            <span class="btn" style="padding:6px 10px;font-size:12px;">tap</span>
          </div>
          <small>Open, read, and save if it‚Äôs a favorite.</small>
        `;
        div.addEventListener("click", () => {
          openModal(L.title, `
            <div class="letterText">${escapeHTML(L.text)}</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
              <button class="btn primary" id="saveFavBtn">Save to Favorites</button>
              <button class="btn" id="copyBtn">Copy</button>
            </div>
          `);

          document.getElementById("saveFavBtn").onclick = () => {
            const favs = getFavs();
            if (!favs.find(x => x.id === L.id)){
              favs.unshift({ id: L.id, title: L.title, text: L.text });
              setFavs(favs);
              renderFavs();
            }
            closeModal();
          };

          document.getElementById("copyBtn").onclick = async () => {
            try{
              await navigator.clipboard.writeText(L.text);
              document.getElementById("copyBtn").textContent = "Copied ‚úì";
              setTimeout(() => document.getElementById("copyBtn").textContent = "Copy", 900);
            }catch{
              document.getElementById("copyBtn").textContent = "Copy failed";
            }
          };
        });
        lettersGrid.appendChild(div);
      });
    }

    function renderFavs(){
      const favs = getFavs();
      if (favs.length === 0){
        favList.innerHTML = `<div class="surpriseBox">No favorites yet. Save one from the letters above ü§ç</div>`;
        return;
      }
      favList.innerHTML = "";
      favs.forEach(item => {
        const row = document.createElement("div");
        row.className = "favItem";
        row.innerHTML = `
          <div style="min-width:0">
            <b>${escapeHTML(item.title)}</b>
            <p>${escapeHTML(item.text)}</p>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end">
            <button class="mini" data-open="1">Open</button>
            <button class="mini" data-del="1">Remove</button>
          </div>
        `;
        row.querySelector('[data-open="1"]').onclick =
          () => openModal(item.title, `<div class="letterText">${escapeHTML(item.text)}</div>`);
        row.querySelector('[data-del="1"]').onclick = () => {
          const next = getFavs().filter(x => x.id !== item.id);
          setFavs(next);
          renderFavs();
        };
        favList.appendChild(row);
      });
    }

    // Gallery
    const albumTabs = document.getElementById("albumTabs");
    const photosGrid = document.getElementById("photosGrid");
    let activeAlbumId = ALBUMS[0]?.id || "";

    function renderAlbumTabs(){
      albumTabs.innerHTML = "";
      ALBUMS.forEach(A => {
        const b = document.createElement("button");
        b.className = "tab" + (A.id === activeAlbumId ? " active" : "");
        b.type = "button";
        b.textContent = A.name;
        b.onclick = () => { activeAlbumId = A.id; renderAlbumTabs(); renderPhotos(); };
        albumTabs.appendChild(b);
      });
    }

    function renderPhotos(){
      const A = ALBUMS.find(x => x.id === activeAlbumId);
      photosGrid.innerHTML = "";
      if (!A || A.photos.length === 0){
        photosGrid.innerHTML = `<div class="surpriseBox">No photos yet.</div>`;
        return;
      }
      A.photos.forEach((ph, idx) => {
        const tile = document.createElement("div");
        tile.className = "photo";
        tile.innerHTML = `
          <img src="${ph.src}" alt="photo ${idx+1}" loading="lazy" />
          <div class="cap">${escapeHTML(ph.caption || "‚Äî")}</div>
        `;
        tile.onclick = () => openModal(A.name, `
          <img style="width:100%;max-height:70vh;object-fit:contain;display:block;background:rgba(250,247,242,.6);" src="${ph.src}" alt="lightbox" />
          <div style="padding:12px 16px;color:var(--muted);font-size:13px;line-height:1.7;border-top:1px solid rgba(107,122,79,.12);">
            ${escapeHTML(ph.caption || "")}
          </div>
        `);
        photosGrid.appendChild(tile);
      });
    }

    // Daily surprise
    const dailyBox = document.getElementById("dailyBox");
    const rerollBtn = document.getElementById("rerollBtn");

    function dayKey(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    function hashToIndex(seedStr, mod){
      let h = 2166136261;
      for (let i=0; i<seedStr.length; i++){
        h ^= seedStr.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return Math.abs(h) % mod;
    }
    function getRerollOffset(){ return Number(localStorage.getItem(REROLL_KEY) || "0"); }
    function setRerollOffset(v){ localStorage.setItem(REROLL_KEY, String(v)); }

    function setDaily(){
      const today = new Date();
      const base = hashToIndex(dayKey(today), SURPRISES.length);
      const idx = (base + getRerollOffset()) % SURPRISES.length;
      dailyBox.textContent = SURPRISES[idx];
    }
    rerollBtn.onclick = () => {
      const next = (getRerollOffset() + 1) % SURPRISES.length;
      setRerollOffset(next);
      setDaily();
    };

    // Clue hunt
    const codeInput = document.getElementById("codeInput");
    const unlockBtn = document.getElementById("unlockBtn");
    const giftGrid = document.getElementById("giftGrid");

    function getUnlocks(){ return readJSON(UNLOCK_KEY, []); }
    function setUnlocks(list){ writeJSON(UNLOCK_KEY, list); }

    function renderGifts(){
      const unlocked = new Set(getUnlocks().map(x => String(x).toUpperCase()));
      giftGrid.innerHTML = "";
      GIFTS.forEach(g => {
        const isOpen = unlocked.has(g.code.toUpperCase());
        const div = document.createElement("div");
        div.className = "gift";
        div.innerHTML = isOpen
          ? `<b>${escapeHTML(g.title)}</b><p>${escapeHTML(g.text)}</p>`
          : `<b>Locked Gift üîí</b><p>Find the code to unlock this one.</p>`;
        giftGrid.appendChild(div);
      });
    }

    unlockBtn.onclick = () => {
      const raw = (codeInput.value || "").trim().toUpperCase();
      if (!raw) return;

      const match = GIFTS.find(g => g.code.toUpperCase() === raw);
      if (!match){
        openModal("Nope ü§ç", `<div class="letterText">That code doesn‚Äôt unlock anything (yet). Try <b>LIA</b>, <b>HUSISA</b>, or <b>20251225</b>.</div>`);
        return;
      }

      const unlocks = getUnlocks().map(x => String(x).toUpperCase());
      if (!unlocks.includes(raw)){
        unlocks.push(raw);
        setUnlocks(unlocks);
      }
      renderGifts();
      openModal("Unlocked ‚ú®", `<div class="letterText"><b>${escapeHTML(match.title)}</b><br><br>${escapeHTML(match.text)}</div>`);
      codeInput.value = "";
    };

    codeInput.addEventListener("keydown", (e) => { if (e.key === "Enter") unlockBtn.click(); });

    // Reset (no duplicate IDs)
    document.getElementById("resetBtn").onclick = () => {
      localStorage.removeItem(FAV_KEY);
      localStorage.removeItem(UNLOCK_KEY);
      localStorage.removeItem(REROLL_KEY);
      renderFavs();
      renderGifts();
      setDaily();
      openModal("Reset done", `<div class="letterText">Favorites + unlocked gifts cleared on this device.</div>`);
    };
    document.getElementById("resetBtn2").onclick = () => document.getElementById("resetBtn").click();

    // Init
    renderLetters();
    renderFavs();
    renderAlbumTabs();
    renderPhotos();
    setDaily();
    renderGifts();

    // Start safe: don't autoplay unless saved ON
    // (If saved ON, it'll try on first interaction + after unlock)
    if(savedMusicOn){
      // keep label as pause
      setMusicBtnLabel(true);
    }else{
      setMusicBtnLabel(false);
    }
  </script>
</body>
</html>
